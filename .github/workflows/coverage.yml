---
name: "Coverage workflow"

on:
  pull_request:
    branches:
      - "main"
  push:
    branches:
      - "main"

permissions:
  contents: "read"

jobs:
  coverage:
    name: "Coverage ${{ github.event_name }}"
    runs-on: "ubuntu-latest"
    steps:
      # Checkout code
      - name: "Checkout project"
        uses: "actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8"
        with:
          fetch-depth: 1
          persist-credentials: false

      # Install golang
      - name: "Set-up Go"
        uses: "actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c"
        with:
          go-version: "stable"

      # Generate coverage
      - name: "Generate test coverage"
        continue-on-error: true
        shell: "bash"
        run: "go test ./... -coverprofile=./cover.out -covermode=atomic -coverpkg=./..."

  coverage-report:
    name: "Coverage report ${{ github.event_name }}"
    needs: "coverage"
    runs-on: "ubuntu-latest"
    permissions:
      contents: "read"
      actions: "read" # to download code coverage
      pull-requests: "write" # write permission needed to comment on PR
    steps:
      # Retrieve coverage breakdown
      - name: "Download artifact (coverage.breakdown.txt)"
        id: "download-main-breakdown"
        uses: "dawidd6/action-download-artifact@ac66b43f0e6a346234dd65d4d0c8fbb31cb316e5"
        with:
          branch: "main"
          workflow_conclusion: "success"
          name: "coverage.breakdown.txt"
          if_no_artifact_found: "warn"

      # Upload coverage comment
      - name: "Check test coverage"
        id: "go-test-coverage"
        uses: "vladopajic/go-test-coverage/action/source@d9ec07b8799c458a7bc1f9b36d14261746d63529"
        continue-on-error: true
        with:
          # config
          profile: "cover.out"
          threshold-total: 95
          # badges
          git-branch: "${{ github.event_name == 'push' && 'badges' || '' }}"
          git-token: "${{ github.event_name == 'push' && secrets.GITHUB_TOKEN || '' }}"
          # diff
          breakdown-file-name: "coverage.breakdown.txt"
          diff-base-breakdown-file-name: |-
            ${{
              steps.download-main-breakdown.outputs.found_artifact == 'true'
              && 'coverage.breakdown.txt'
              || ''
            }}

      # Render coverage map
      - name: "Generate coverage tree map"
        shell: "bash"
        run: |
          go run github.com/nikolaydubina/go-cover-treemap@latest \
              -coverprofile cover.out \
          >coverage-treemap.svg

      # Upload coverage breakdown
      - name: "Upload artifact (coverage.breakdown.txt)"
        uses: "actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4"
        with:
          name: "coverage.breakdown.txt"
          path: "coverage.breakdown.txt"
          if-no-files-found: "error"

      # Upload coverage artifacts
      - name: "Upload artifact (coverage files)"
        uses: "actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4"
        with:
          name: "coverage-artifacts.zip"
          path: |
            cover.out
            coverage.breakdown.txt
            coverage-treemap.svg
          if-no-files-found: "error"

      # Comment PR
      - name: "Comment PR with coverage"
        if: "github.event_name == 'pull_request'"
        uses: "thollander/actions-comment-pull-request@24bffb9b452ba05a4f3f77933840a6a841d1b32b"
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
          comment-tag: "go-coverage"
          message: |
            _(execution #**${{ github.run_id }}** / attempt **${{ github.run_attempt }}**)_

            ## Test coverage report:

            ```
            ${{ fromJSON(steps.go-test-coverage.outputs.report) }}
            ```

            (coverage map available in artifacts)
          reactions: "${{ steps.go-test-coverage.outcome == 'failure' && 'confused' || 'hooray' }}"

      # Assert coverage passes threshold
      - name: "Validate coverage passes threshold"
        if: "steps.go-test-coverage.outcome == 'failure'"
        shell: "bash"
        run: "echo 'Coverage below threshold' && exit 1"
